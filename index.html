<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye-Tracking Communicator</title>
    <!-- Load WebGazer.js from a stable CDN -->
    <script src="https://cdn.jsdelivr.net/npm/webgazer" type="text/javascript"></script>
    <style>
        body { font-family: 'Arial', sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding: 20px; }
        
        #sentence-bar {
            background: white; padding: 20px; font-size: 28px; border: 2px solid #333;
            min-height: 40px; margin-bottom: 20px; border-radius: 10px;
        }

        .grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            max-width: 800px; margin: 0 auto;
        }

        .card {
            background: white; border: 1px solid #ccc; border-radius: 8px;
            padding: 40px; font-size: 24px; cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            position: relative;
            user-select: none; /* Prevent text selection */
        }
        
        .card.gazing { background: #e0f7fa; transform: scale(1.05); border: 2px solid #00acc1; }
        
        .progress {
            position: absolute; bottom: 0; left: 0; height: 5px; background: #00acc1; width: 0%;
        }

        .controls { margin-top: 30px; display: flex; justify-content: center; gap: 20px; }
        .btn-action {
            padding: 15px 30px; font-size: 20px; border: none; border-radius: 5px; color: white; cursor: pointer;
        }
        .btn-speak { background: #2196F3; }
        .btn-translate { background: #4CAF50; }
        .btn-clear { background: #f44336; }

        /* Force video to top left */
        #webgazerVideoContainer {
            position: fixed !important; top: 10px !important; left: 10px !important;
            width: 240px !important; height: 180px !important; border: 2px solid red; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="sentence-bar">Thinking...</div>

    <div class="grid" id="word-grid"></div>

    <div class="controls">
        <button class="btn-action btn-speak" id="btn-speak">Speak</button>
        <button class="btn-action btn-translate" id="btn-translate">Translate (ES)</button>
        <button class="btn-action btn-clear" id="btn-clear">Clear</button>
    </div>

    <p style="margin-top:20px; color:gray;">
        <b>Calibration:</b> 1. Allow Camera. 2. Click the RED DOTS to calibrate. <br>
        3. Stare at a word for <b>2 seconds</b> to select it.
    </p>

<script>
    const WORDS = ["YES", "NO", "WATER", "FOOD", "PAIN", "TOILET", "COLD", "HOT", "THANKS"];
    const TRANSLATIONS = {
        "YES": "SÍ", "NO": "NO", "WATER": "AGUA", "FOOD": "COMIDA",
        "PAIN": "DOLOR", "TOILET": "BAÑO", "COLD": "FRÍO", "HOT": "CALIENTE",
        "THANKS": "GRACIAS"
    };

    const DWELL_TIME_MS = 2000; 
    let sentence = [];
    let currentGazeTarget = null;
    let gazeStartTime = 0;
    const synth = window.speechSynthesis;
    const sentenceBar = document.getElementById('sentence-bar');
    const wordGrid = document.getElementById('word-grid');

    // Build Grid
    WORDS.forEach(word => {
        const div = document.createElement('div');
        div.className = 'card';
        div.dataset.word = word;
        div.innerHTML = `${word}<div class="progress"></div>`;
        wordGrid.appendChild(div);
    });

    window.onload = async function() {
        // Initialize WebGazer
        await webgazer.setRegression('ridge') 
            .setGazeListener((data, clock) => {
                if (data) checkGaze(data.x, data.y);
            })
            .saveDataAcrossSessions(true)
            .begin();
            
        webgazer.showPredictionPoints(true); 
    };

    function checkGaze(x, y) {
        const element = document.elementFromPoint(x, y);
        if (element && element.classList.contains('card')) {
            if (currentGazeTarget !== element) {
                resetGaze();
                currentGazeTarget = element;
                element.classList.add('gazing');
                gazeStartTime = Date.now();
                requestAnimationFrame(updateDwell);
            }
        } else {
            resetGaze();
        }
    }

    function updateDwell() {
        if (!currentGazeTarget) return;
        const elapsed = Date.now() - gazeStartTime;
        const bar = currentGazeTarget.querySelector('.progress');
        if(bar) bar.style.width = Math.min((elapsed / DWELL_TIME_MS) * 100, 100) + '%';

        if (elapsed >= DWELL_TIME_MS) {
            selectWord(currentGazeTarget.dataset.word);
            resetGaze();
        } else {
            requestAnimationFrame(updateDwell);
        }
    }

    function resetGaze() {
        if (currentGazeTarget) {
            currentGazeTarget.classList.remove('gazing');
            const bar = currentGazeTarget.querySelector('.progress');
            if(bar) bar.style.width = '0%';
        }
        currentGazeTarget = null;
    }

    function selectWord(word) {
        sentence.push(word);
        sentenceBar.innerText = sentence.join(" ");
        speak(word);
        const btn = document.querySelector(`.card[data-word="${word}"]`);
        if(btn) {
            btn.style.backgroundColor = '#81c784';
            setTimeout(() => btn.style.backgroundColor = 'white', 300);
        }
    }

    function speak(text, lang='en-US') {
        if (text === '') return;
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.lang = lang;
        synth.speak(utterThis);
    }

    document.getElementById('btn-speak').onclick = () => speak(sentence.join(" "));
    document.getElementById('btn-clear').onclick = () => { sentence = []; sentenceBar.innerText = ""; };
    document.getElementById('btn-translate').onclick = () => {
        const translated = sentence.map(w => TRANSLATIONS[w] || w).join(" ");
        sentenceBar.innerText = translated;
        speak(translated, 'es-ES');
    };

    window.onbeforeunload = () => webgazer.end();
</script>
</body>
</html>
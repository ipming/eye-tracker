<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye-Tracking Communicator</title>
    <script src="https://cdn.jsdelivr.net/npm/webgazer" type="text/javascript"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; text-align: center; background: #f0f0f0; 
            margin: 0; padding: 20px; overflow: hidden; /* Prevent scrolling */
        }

        /* --- CALIBRATION OVERLAY --- */
        #calibration-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .cal-point {
            width: 30px; height: 30px; border-radius: 50%;
            background: red; border: 3px solid white;
            position: absolute; cursor: pointer;
            transition: transform 0.2s;
        }
        .cal-point:active { transform: scale(0.8); background: yellow; }

        /* Positions for 5-point calibration */
        #pt1 { top: 10%; left: 10%; } /* Top Left */
        #pt2 { top: 10%; right: 50%; transform: translateX(50%); } /* Top Center */
        #pt3 { top: 10%; right: 10%; } /* Top Right */
        #pt4 { bottom: 10%; left: 10%; } /* Bottom Left */
        #pt5 { bottom: 10%; right: 10%; } /* Bottom Right */
        #pt-center { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; }

        #cal-instructions {
            color: white; font-size: 24px; margin-top: -100px;
        }

        /* --- MAIN UI --- */
        #main-interface { display: none; opacity: 0; transition: opacity 1s; }

        #sentence-bar {
            background: white; padding: 20px; font-size: 28px; border: 2px solid #333;
            min-height: 40px; margin-bottom: 30px; border-radius: 10px; width: 60%; margin-left: 5%;
        }

        .grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            max-width: 800px; margin: 0 auto;
        }

        .card {
            background: white; border: 1px solid #ccc; border-radius: 8px;
            padding: 40px; font-size: 24px; cursor: pointer;
            position: relative; user-select: none;
        }
        
        .card.gazing { background: #e0f7fa; transform: scale(1.02); border: 2px solid #00acc1; }
        
        .progress {
            position: absolute; bottom: 0; left: 0; height: 5px; background: #00acc1; width: 0%;
            transition: width 0.1s linear;
        }

        .controls { margin-top: 40px; display: flex; justify-content: center; gap: 20px; }
        .btn-action { padding: 15px 30px; font-size: 20px; border: none; border-radius: 5px; color: white; cursor: pointer; }
        .btn-speak { background: #2196F3; }
        .btn-translate { background: #4CAF50; }
        .btn-clear { background: #f44336; }

        /* --- VIDEO PANEL (Top Right) --- */
        #webgazerVideoContainer {
            position: fixed !important; top: 10px !important; right: 10px !important; left: auto !important;
            width: 200px !important; height: auto !important;
            border: 3px solid #333; border-radius: 10px; z-index: 5000;
        }
    </style>
</head>
<body>

    <!-- CALIBRATION SCREEN -->
    <div id="calibration-overlay">
        <div id="cal-instructions">
            Look at the RED DOTS and click each one <b>5 times</b>.<br>
            <span style="font-size:16px; color: #ccc;">(Keep your head still!)</span>
        </div>
        <div class="cal-point" id="pt1" onclick="recordCalibration(this)"></div>
        <div class="cal-point" id="pt2" onclick="recordCalibration(this)"></div>
        <div class="cal-point" id="pt3" onclick="recordCalibration(this)"></div>
        <div class="cal-point" id="pt-center" onclick="recordCalibration(this)"></div>
        <div class="cal-point" id="pt4" onclick="recordCalibration(this)"></div>
        <div class="cal-point" id="pt5" onclick="recordCalibration(this)"></div>
    </div>

    <!-- MAIN APP -->
    <div id="main-interface">
        <div id="sentence-bar">Thinking...</div>
        <div class="grid" id="word-grid"></div>
        <div class="controls">
            <button class="btn-action btn-speak" id="btn-speak">Speak</button>
            <button class="btn-action btn-translate" id="btn-translate">Translate (ES)</button>
            <button class="btn-action btn-clear" id="btn-clear">Clear</button>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const WORDS = ["YES", "NO", "WATER", "FOOD", "PAIN", "TOILET", "COLD", "HOT", "THANKS"];
    const TRANSLATIONS = {
        "YES": "SÍ", "NO": "NO", "WATER": "AGUA", "FOOD": "COMIDA",
        "PAIN": "DOLOR", "TOILET": "BAÑO", "COLD": "FRÍO", "HOT": "CALIENTE", "THANKS": "GRACIAS"
    };
    
    // ADJUST THESE FOR PERFORMANCE
    const DWELL_TIME_MS = 1000; 
    const SMOOTHING_BUFFER_SIZE = 25; // Higher = Smoother but slower lag. Lower = Jittery but fast.

    // --- VARIABLES ---
    let sentence = [];
    let currentGazeTarget = null;
    let gazeStartTime = 0;
    
    // Smoothing Arrays
    let xHistory = [];
    let yHistory = [];

    // Calibration State
    let calibrationClicks = 0;
    const TOTAL_CLICKS_NEEDED = 30; // 6 dots * 5 clicks each

    const synth = window.speechSynthesis;
    const sentenceBar = document.getElementById('sentence-bar');
    const wordGrid = document.getElementById('word-grid');

    // Build Word Grid
    WORDS.forEach(word => {
        const div = document.createElement('div');
        div.className = 'card';
        div.dataset.word = word;
        div.innerHTML = `${word}<div class="progress"></div>`;
        wordGrid.appendChild(div);
    });

    // --- WEBGAZER SETUP ---
    window.onload = async function() {
        webgazer.clearData(); // Wipe old data

        await webgazer.setRegression('ridge') 
            .setGazeListener((data, clock) => {
                if (data == null) return;
                
                // 1. APPLY SMOOTHING
                const smoothPos = getSmoothedCoordinates(data.x, data.y);
                
                // 2. CHECK INTERACTION (Only if calibration is done)
                if(document.getElementById('calibration-overlay').style.display === 'none'){
                    checkGaze(smoothPos.x, smoothPos.y);
                }
            })
            .saveDataAcrossSessions(false) // Don't save across reloads for fresh calibration
            .begin();
            
        // Show the red prediction dot to help user see where computer thinks they are looking
        webgazer.showPredictionPoints(true); 
    };

    // --- SMOOTHING ALGORITHM ---
    function getSmoothedCoordinates(x, y) {
        xHistory.push(x);
        yHistory.push(y);

        // Keep buffer at fixed size
        if (xHistory.length > SMOOTHING_BUFFER_SIZE) {
            xHistory.shift();
            yHistory.shift();
        }

        // Calculate Average
        const avgX = xHistory.reduce((a, b) => a + b, 0) / xHistory.length;
        const avgY = yHistory.reduce((a, b) => a + b, 0) / yHistory.length;

        return { x: avgX, y: avgY };
    }

    // --- CALIBRATION LOGIC ---
    function recordCalibration(element) {
        calibrationClicks++;
        
        // Visual feedback on click
        let opacity = parseFloat(element.style.opacity || 1);
        element.style.opacity = opacity - 0.15; // Fade out slightly per click

        if (calibrationClicks >= TOTAL_CLICKS_NEEDED) {
            endCalibration();
        }
    }

    function endCalibration() {
        document.getElementById('calibration-overlay').style.display = 'none';
        const main = document.getElementById('main-interface');
        main.style.display = 'block';
        setTimeout(() => main.style.opacity = 1, 100);
        speak("Calibration complete. Ready.");
    }

    // --- GAZE LOGIC ---
    function checkGaze(x, y) {
        const element = document.elementFromPoint(x, y);

        if (element && element.classList.contains('card')) {
            if (currentGazeTarget !== element) {
                resetGaze();
                currentGazeTarget = element;
                element.classList.add('gazing');
                gazeStartTime = Date.now();
                requestAnimationFrame(updateDwell);
            }
        } else {
            resetGaze();
        }
    }

    function updateDwell() {
        if (!currentGazeTarget) return;
        const elapsed = Date.now() - gazeStartTime;
        const bar = currentGazeTarget.querySelector('.progress');
        if(bar) bar.style.width = Math.min((elapsed / DWELL_TIME_MS) * 100, 100) + '%';

        if (elapsed >= DWELL_TIME_MS) {
            selectWord(currentGazeTarget.dataset.word);
            resetGaze();
        } else {
            requestAnimationFrame(updateDwell);
        }
    }

    function resetGaze() {
        if (currentGazeTarget) {
            currentGazeTarget.classList.remove('gazing');
            const bar = currentGazeTarget.querySelector('.progress');
            if(bar) bar.style.width = '0%';
        }
        currentGazeTarget = null;
    }

    // --- APP FUNCTIONS ---
    function selectWord(word) {
        sentence.push(word);
        sentenceBar.innerText = sentence.join(" ");
        speak(word);
        
        const btn = document.querySelector(`.card[data-word="${word}"]`);
        if(btn) {
            btn.style.backgroundColor = '#81c784';
            setTimeout(() => btn.style.backgroundColor = 'white', 300);
        }
    }

    function speak(text, lang='en-US') {
        if (text === '') return;
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.lang = lang;
        synth.speak(utterThis);
    }

    document.getElementById('btn-speak').onclick = () => speak(sentence.join(" "));
    document.getElementById('btn-clear').onclick = () => { sentence = []; sentenceBar.innerText = "Thinking..."; };
    document.getElementById('btn-translate').onclick = () => {
        const translated = sentence.map(w => TRANSLATIONS[w] || w).join(" ");
        sentenceBar.innerText = translated;
        speak(translated, 'es-ES');
    };

    window.onbeforeunload = () => webgazer.end();
</script>
</body>
</html>

